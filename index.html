<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="blocksdk.js"></script>
</head>
<body>
    <!-- hidden fields - start -->
    <!-- imageUrl : 'imageUrl',
    imageBase64 : 'imageBase64',
    imagePosition : {
        width : '100px',
        height : '100px',
        margin : {
            top : '5px',
            bottom : '5px',
            left : '5px',
            right : '5px'
        },
        padding : {
            top : '5px',
            bottom : '5px',
            left : '5px',
            right : '5px'
        } -->
    <input type='hidden' id="hiddentextOverImage"></input>
    <input type='hidden' id="hiddenfontBase64"></input>
    <input type='hidden' id="hiddenimageUrl"></input>
    <input type='hidden' id="hiddenimageBase64"></input>
    <input type='hidden' id="hiddenimagePosition_width"></input>
    <input type='hidden' id="hiddenimagePosition_height"></input>
    <!-- hidden fields - end  -->
<div class="container">
  <div class="row">
    <div class="col-sm">
      <div class="jumbotron text-left">
        <p>Text over image</p>
        <!-- CKEditor - Start -->
        <div id="editor"></div>
        <script src="https://cdn.ckeditor.com/ckeditor5/34.0.0/classic/ckeditor.js"></script>
        <script>
          var ce = ClassicEditor
              .create( document.querySelector( '#editor' ) )
              .then( newEditor => {
                editor = newEditor;
              })
              .catch( error => {
                  console.error( error );
              } );     
        </script>
        <!-- CKEditor - End -->
      </div>
    </div>
  </div>
  <!-- Addition Settings - Start -->
  <div class="row">
    <div class="col-sm">
      <div class="jumbotron text-left">
        <div id='customFontContent'></div>
        <p>Additional Settings</p>
        <div class="d-flex p-2">Tip: Add custom font that will be stored as base64 encoded font in your image</div>
        <label class="d-flex p-2" for="uploadFont">Upload Font</label>
        <input type="file" class="form-control" id="uploadFont" accept=".woff,.ttf,.otf, "/>
      </div>
    </div>
  </div>
  <script>
    // Font Upload preview code 
    //https://jsfiddle.net/bootstrapious/8w7a50n2
    $(function () {
      $('#uploadFont').on('change', function () {
          readFontURL(inputFont);
      });
    });
    function readFontURL(inputFont) {
      if (inputFont.files && inputFont.files[0]) {
          var reader = new FileReader();
  
          reader.onload = function (e) {
              
            console.log('base64 of uploaded font ' + reader.result);
            document.getElementById('hiddenfontBase64').value = reader.result;  
            //MK TODO: Set sdk.setData( imageBase64 = reader.result)
          };
          reader.readAsDataURL(inputFont.files[0]);
      }
    }

    var inputFont = document.getElementById( 'uploadFont' );
    inputFont.addEventListener( 'change', showFontName );
    function showFontName( event ) {
      console.log('showFontName fn.')
      var inputFont = event.srcElement;
      var fileName = inputFont.files[0].name;
    }

  </script>
  <!-- Addition Settings - End -->
  <!-- Image - Start -->
  <div class="row">
    <div class="col-sm">
      <div class="jumbotron text-left">
        <p>Image</p>
        <div class="d-flex p-2">Tip: provide an external URL or browse from assets</div>
        <label for="imageUrl">External URL</label>
        <input type="text" class="form-control" id="imageUrl">
        <label class="d-flex p-2" for="uploadImage">Upload Image</label>
        <input type="file" class="form-control" id="uploadImage" accept=".jpg,.gif,.png" />
      </div>
    </div>
  </div>
  <div class="image-area mt-4" style="text-align: center;">
    <label id="upload-label" for="imageResult" class="font-weight-light text-muted" style="display:none">File name</label>
    <img id="imageResult" src="#" alt=""class="img-fluid rounded shadow-sm mx-auto d-block">
  </div>
  <script>

    //Image url preview code 
    document.getElementById('imageUrl').addEventListener("input", function(e){
        document.getElementById('hiddenimageUrl').value = document.getElementById('imageUrl').value; 
        console.log('imageUrl saved to hidden field ' + imageUrl)
        }
    );

    // Image Upload preview code 
    //https://jsfiddle.net/bootstrapious/8w7a50n2
    $(function () {
      $('#uploadImage').on('change', function () {
          readURL(input);
      });
    });
    function readURL(input) {
      if (input.files && input.files[0]) {
          var reader = new FileReader();
  
          reader.onload = function (e) {
              $('#imageResult')
                  .attr('src', e.target.result)
                  .attr('style','height: 100px; width: 100px;');

              console.log('base64 of uploaded image ' + reader.result);
              document.getElementById('hiddenimageBase64').value = reader.result;  
              //MK TODO: Set sdk.setData( imageBase64 = reader.result)
          };
          reader.readAsDataURL(input.files[0]);
      }
    }

    /*  ==========================================
        SHOW UPLOADED IMAGE NAME
    * ========================================== */
    var input = document.getElementById( 'uploadImage' );
    var infoArea = document.getElementById( 'upload-label' );

    input.addEventListener( 'change', showFileName );
    function showFileName( event ) {
      var input = event.srcElement;
      var fileName = input.files[0].name;
      infoArea.textContent = 'File name: ' + fileName;
      infoArea.style.display = "block"
    }

  </script>
  <!-- Image - End -->
  <!-- Image Position - Start -->
  <div class="row">
    <div class="col-sm">
      <div class="jumbotron text-left">
        <p>Image Position</p>
        <div class = "jumbotron" style="background-color: beige; width:50%; height: 50%; margin: auto">
          <div>left</div>
          <div>right</div>
          <div>top</div>
          <div>bottom</div>
          <div class = "jumbotron" style="background-color:burlywood; width:100%; height: 100%; margin: auto">
          </div>
        </div>
    </div>
  </div>
  <!-- Image Position - End -->
  <br>
  <!-- Submit - Start -->
  <input type="button" id="submit" value="submit"/>
  <script>
      //mk123 TODO - See if CK Editor on change can be used
      document.querySelector( '#submit' ).addEventListener( 'click', () => {
        const editorData = editor.getData();
        document.getElementById('hiddentextOverImage').value = editorData;
        console.log(editorData);

        saveData()
      });
  </script>
  <!-- Submit - End -->
</div>
<!-- Script for SDK - Start -->
<script>
    var sdk = new window.sfdc.BlockSDK({
        blockEditorWidth: 500,
        tabs: ["htmlblock", "stylingblock"],
      });
    sdk.getData(function (data) {
        console.log('Data on page load ' + JSON.stringify(data));
        if(isEmptyObject(data)) {
            //empty - set default value in screen
            editor.setData("Enter Text for overlaying");
        }else {
            //Not empty - set stored value in screen
            //Set hidden input value
            document.getElementById('hiddentextOverImage').value = data.textOverImage;
            document.getElementById('hiddenfontBase64').value = data.fontBase64;
            document.getElementById('hiddenimageUrl').value = data.imageUrl;
            document.getElementById('hiddenimageBase64').value = data.imageBase64;
            document.getElementById('hiddenimagePosition_width').value = data.imagePosition.width;
            document.getElementById('hiddenimagePosition_height').value = data.imagePosition.height;

            //Set UI Value
            editor.setData(data.textOverImage);
            document.getElementById('imageUrl').value = data.imageUrl;
            document.getElementById('imageResult').src = data.imageBase64; // mk todo - show file name in UI
        }
    });

    function saveData() {
        var hiddentextOverImage = document.getElementById('hiddentextOverImage').value;
        var hiddenfontBase64 = document.getElementById('hiddenfontBase64').value;
        var hiddenimageUrl = document.getElementById('hiddenimageUrl').value;
        var hiddenimageBase64 = document.getElementById('hiddenimageBase64').value;
        var hiddenimagePosition_width = document.getElementById('hiddenimagePosition_width').value;
        var hiddenimagePosition_height = document.getElementById('hiddenimagePosition_height').value;
        var data = {
            textOverImage : hiddentextOverImage,
            fontBase64 : hiddenfontBase64,
            imageUrl : hiddenimageUrl,
            imageBase64 : hiddenimageBase64,
            imagePosition : {
                width : '100px',
                height : '100px',
                margin : {
                    top : '5px',
                    bottom : '5px',
                    left : '5px',
                    right : '5px'
                },
                padding : {
                    top : '5px',
                    bottom : '5px',
                    left : '5px',
                    right : '5px'
                }
            }
        }


        sdk.getData(function (gdata) {
            console.log('Get Data on Save ' + JSON.stringify(gdata));
            sdk.setData(data);//Set Data Ends
        });//Get Data Ends

        //Set content for preview
        sdk.setContent(generateHTMLContent(data));
    }//Save Data Ends 

    function generateHTMLContent(dataJson){
        /* set font - start */

        var fontName = 'customFont'
        var parentDiv = document.createElement('div')
        var newStyle = document.createElement('style');
        newStyle.appendChild(document.createTextNode('@font-face{font-family: '+fontName+'; src: url('+dataJson.fontBase64+');}'));
        //document.body.appendChild(newStyle);
        parentDiv.appendChild(newStyle);

        var imgDiv = document.createElement('div');
        imgDiv.style = "position: relative;text-align: center;color: white;"; /* mk123 TODO : change this based on position */
        imgDiv.innerHTML = dataJson.textOverImage;
        var imgTag = document.createElement('img');
        imgTag.src = dataJson.imageBase64; 
        imgTag.alt = "SNOW"
        imgTag.style = "width:100%;"

        parentDiv.appendChild(imgDiv);
        console.log('HTML to render ' + parentDiv);

        return parentDiv;

        /* set font - end */
        
        /*var posContent;
        //harcoded - mk123
        //setting position 
        position = 'centered';
        if(position == 'bottom-left') {
          posContent = '<div style="font-family: customFont; position: absolute;bottom: 8px;left: 16px;">'+dataJson.textOverImage+'</div>'
        }else if(position == 'top-left') {
          posContent = '<div style="font-family: customFont; position: absolute;top: 8px;left: 16px;">'+dataJson.textOverImage+'</div>'
        }else if(position == 'top-right') {
          posContent = '<div style="font-family: customFont; position: absolute;top: 8px;right: 16px;">'+dataJson.textOverImage+'</div>'
        }else if(position == 'bottom-right') {
          posContent = '<div style="font-family: customFont; position: absolute;bottom: 8px;right: 16px;">'+dataJson.textOverImage+'</div>'
        }else if(position == 'centered') {
          posContent = '<div style="font-family: customFont; position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);">'+dataJson.textOverImage+'</div>'
        }
        */
        //document.getElementById('f').setAttribute('font-family', name)

       
       /* var htmlContent = `<div style="position: relative;text-align: center;color: white;">
            <img src="${dataJson.imageBase64}" alt="Snow" style="width:100%;">
            ${posContent}
          </div>
          `;
        var finalElement = document.getElementById('parentDiv').appendChild(htmlContent);
        console.log('HTML to render ' + finalElement); */
        //return finalElement;
    }

    function isEmptyObject(obj) {
        for (var i in obj) return false;
        return true;
      }   
</script>
<!-- Script for SDK - End -->
</body>
</html>
